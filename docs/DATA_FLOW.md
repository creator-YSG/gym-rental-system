# F-BOX ì‹œìŠ¤í…œ ë°ì´í„° íë¦„ë„

## ê°œìš”

F-BOX ì‹œìŠ¤í…œì˜ ì£¼ìš” ë°ì´í„° íë¦„ì„ ì‹œë‚˜ë¦¬ì˜¤ë³„ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.
**ê²°ì œ ë°©ì‹**: ê¸ˆì•¡ê¶Œ/êµ¬ë…ê¶Œ ê¸°ë°˜ ì‹œìŠ¤í…œ

---

## ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë½ì¹´í‚¤ ëŒ€ì—¬ê¸°   â”‚
â”‚  (í„°ì¹˜ìŠ¤í¬ë¦°)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP GET (Pull)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ìš´ë™ë³µ/ìˆ˜ê±´ ëŒ€ì—¬ê¸° ë¼ì¦ˆë² ë¦¬íŒŒì´     â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SQLite  â”‚  â”‚  MQTT ë¸Œë¡œì»¤   â”‚  â”‚
â”‚  â”‚ (ë¡œì»¬ DB)â”‚  â”‚  (Mosquitto)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ MQTT
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“               â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ESP32   â”‚     â”‚ ESP32   â”‚     â”‚ ESP32   â”‚
    â”‚ ìƒì˜ 105â”‚     â”‚ í•˜ì˜ 105â”‚     â”‚  ìˆ˜ê±´   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. ìš´ë™ë³µ/ìˆ˜ê±´ ëŒ€ì—¬ í”Œë¡œìš°

### 1.1 NFC íƒœê·¸ ë° íšŒì› ì¡°íšŒ (Pull ë°©ì‹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì‚¬ìš©ì: ë½ì¹´í‚¤ NFC íƒœê·¸                                  â”‚
â”‚    - ë½ì¹´í‚¤ ë²ˆí˜¸: 105                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ìš´ë™ë³µ ëŒ€ì—¬ê¸° â†’ ë½ì¹´í‚¤ ëŒ€ì—¬ê¸° API í˜¸ì¶œ                  â”‚
â”‚    HTTP GET                                                â”‚
â”‚    URL: http://{ë½ì¹´í‚¤ëŒ€ì—¬ê¸°IP}:5000/api/member/by-locker/105â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ë½ì¹´í‚¤ ëŒ€ì—¬ê¸° ì‘ë‹µ (íšŒì› ID + ì´ë¦„ë§Œ)                   â”‚
â”‚    {                                                       â”‚
â”‚      "status": "ok",                                       â”‚
â”‚      "member_id": "A001",                                  â”‚
â”‚      "name": "í™ê¸¸ë™",                                      â”‚
â”‚      "assigned_at": "2024-12-01T10:00:00"                  â”‚
â”‚    }                                                       â”‚
â”‚                                                            â”‚
â”‚    *** ê¸ˆì•¡ê¶Œ/êµ¬ë…ê¶Œ ì •ë³´ëŠ” ìš´ë™ë³µ ëŒ€ì—¬ê¸° ë¡œì»¬ DBì—ì„œ ì¡°íšŒ ***â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ë¡œì»¬ DBì—ì„œ ê¸ˆì•¡ê¶Œ/êµ¬ë…ê¶Œ ì¡°íšŒ                          â”‚
â”‚    - member_vouchers (í™œì„± ê¸ˆì•¡ê¶Œë“¤)                       â”‚
â”‚    - member_subscriptions (í™œì„± êµ¬ë…ê¶Œë“¤)                  â”‚
â”‚    - subscription_usage (ì˜¤ëŠ˜ êµ¬ë…ê¶Œ ì‚¬ìš©ëŸ‰)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ìƒí’ˆ ëª©ë¡ ì¡°íšŒ                                          â”‚
â”‚    SELECT * FROM products WHERE enabled = 1                â”‚
â”‚    ê²°ê³¼: ìš´ë™ë³µ ìƒì˜/í•˜ì˜, ìˆ˜ê±´ (ê°€ê²© í¬í•¨)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. í„°ì¹˜ìŠ¤í¬ë¦°ì— í‘œì‹œ                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ í™ê¸¸ë™ë‹˜                                    â”‚         â”‚
â”‚   â”‚ ê¸ˆì•¡ê¶Œ ì”ì•¡: 50,000ì› â”‚ êµ¬ë…ê¶Œ: 3ê°œì›” ê¸°ë³¸ê¶Œâ”‚         â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚   â”‚ ìš´ë™ë³µ ìƒì˜ (1,000ì›/ë²Œ)                    â”‚         â”‚
â”‚   â”‚  â–¡ 95   â–¡ 100   â˜‘ 105   â–¡ 110              â”‚         â”‚
â”‚   â”‚ ìš´ë™ë³µ í•˜ì˜ (1,000ì›/ë²Œ)                    â”‚         â”‚
â”‚   â”‚  â˜‘ 105                                     â”‚         â”‚
â”‚   â”‚ ìˆ˜ê±´ (500ì›/ì¥)                             â”‚         â”‚
â”‚   â”‚  â˜‘ x2                                      â”‚         â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚   â”‚ í•©ê³„: 3,000ì› â”‚ êµ¬ë…ê¶Œ ì”ì—¬: ìƒì˜1 í•˜ì˜1 ìˆ˜ê±´1â”‚       â”‚
â”‚   â”‚ [êµ¬ë…ê¶Œ ì‚¬ìš©] [ê¸ˆì•¡ê¶Œ ì‚¬ìš©]                  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 êµ¬ë…ê¶Œ ëŒ€ì—¬ ì²˜ë¦¬ (ë¶€ë¶„ ë°°ì • ì§€ì›)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ì‚¬ìš©ì: [ëŒ€ì—¬í•˜ê¸°] ì„ íƒ                                 â”‚
â”‚    ì¥ë°”êµ¬ë‹ˆ: ìƒì˜ 1ê°œ, í•˜ì˜ 2ê°œ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. êµ¬ë…ê¶Œ ì”ì—¬ í•œë„ í™•ì¸ + ìë™ ë¶€ë¶„ ë°°ì •                  â”‚
â”‚                                                            â”‚
â”‚    êµ¬ë…ê¶Œ ì”ì—¬: ìƒì˜ 1, í•˜ì˜ 1, ìˆ˜ê±´ 1                     â”‚
â”‚    ì¥ë°”êµ¬ë‹ˆ:    ìƒì˜ 1, í•˜ì˜ 2                             â”‚
â”‚                                                            â”‚
â”‚    â˜… ë¶€ë¶„ ë°°ì • ë¡œì§:                                      â”‚
â”‚    for each item in cart:                                  â”‚
â”‚        assignable = min(ì”ì—¬íšŸìˆ˜, ìš”ì²­ìˆ˜ëŸ‰)                â”‚
â”‚        if (assignable > 0):                                â”‚
â”‚            êµ¬ë…ê¶Œì— ë°°ì • (ìˆ˜ëŸ‰: assignable)                â”‚
â”‚            ì”ì—¬íšŸìˆ˜ -= assignable                          â”‚
â”‚            ë‚¨ì€ìˆ˜ëŸ‰ = ìš”ì²­ìˆ˜ëŸ‰ - assignable                â”‚
â”‚        if (ë‚¨ì€ìˆ˜ëŸ‰ > 0):                                  â”‚
â”‚            ê¸ˆì•¡ê¶Œì— ë°°ì • (ìˆ˜ëŸ‰: ë‚¨ì€ìˆ˜ëŸ‰)                  â”‚
â”‚                                                            â”‚
â”‚    ê²°ê³¼:                                                   â”‚
â”‚    - ìƒì˜ 1ê°œ â†’ êµ¬ë…ê¶Œ (ì”ì—¬ 1 â‰¥ 1)                       â”‚
â”‚    - í•˜ì˜ 1ê°œ â†’ êµ¬ë…ê¶Œ (ì”ì—¬ 1, ìš”ì²­ 2 â†’ 1ê°œë§Œ)           â”‚
â”‚    - í•˜ì˜ 1ê°œ â†’ ê¸ˆì•¡ê¶Œ (ë‚¨ì€ 1ê°œ)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ê²°ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ ğŸ“‹ êµ¬ë…ê¶Œ ìë™ ì ìš©                          â”‚         â”‚
â”‚   â”‚   â€¢ ìƒì˜ 1ê°œ, í•˜ì˜ 1ê°œ                       â”‚         â”‚
â”‚   â”‚                                             â”‚         â”‚
â”‚   â”‚ ğŸ’³ ê¸ˆì•¡ê¶Œ ê²°ì œ (1,000ì›)                     â”‚         â”‚
â”‚   â”‚   â€¢ í•˜ì˜ 1ê°œ = 1,000ì›                       â”‚         â”‚
â”‚   â”‚                                             â”‚         â”‚
â”‚   â”‚ [ê¸ˆì•¡ê¶Œ A] ì”ì•¡ 200ì› â–¶ ì‚¬ìš©: [200]ì›       â”‚         â”‚
â”‚   â”‚ [ê¸ˆì•¡ê¶Œ B] ì”ì•¡ 95,000ì› â–¶ ì‚¬ìš©: [800]ì›    â”‚         â”‚
â”‚   â”‚                                             â”‚         â”‚
â”‚   â”‚ [ì·¨ì†Œ]            [ëŒ€ì—¬í•˜ê¸°]                â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. íŠ¸ëœì­ì…˜ ì‹œì‘                                          â”‚
â”‚     BEGIN TRANSACTION                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. êµ¬ë…ê¶Œ ì‚¬ìš©ëŸ‰ ê¸°ë¡                                     â”‚
â”‚     INSERT INTO subscription_usage                         â”‚
â”‚     (member_id, subscription_id, category, quantity, ...)  â”‚
â”‚     VALUES                                                 â”‚
â”‚     ('A001', 1, 'top', 1, ...),                           â”‚
â”‚     ('A001', 1, 'pants', 1, ...),                         â”‚
â”‚     ('A001', 1, 'towel', 1, ...)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. ì¶”ê°€ ê¸ˆì•¡ ì°¨ê° (ìˆ˜ê±´ 1ê°œ 500ì›)                        â”‚
â”‚     UPDATE member_vouchers                                 â”‚
â”‚     SET remaining_amount = remaining_amount - 500          â”‚
â”‚     WHERE id = 1 (ì„ íƒëœ ê¸ˆì•¡ê¶Œ)                           â”‚
â”‚                                                            â”‚
â”‚     INSERT INTO voucher_transactions                       â”‚
â”‚     (voucher_id, amount, type, rental_log_id, ...)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. ëŒ€ì—¬ ë¡œê·¸ ê¸°ë¡                                         â”‚
â”‚     INSERT INTO rental_logs VALUES                         â”‚
â”‚     ('A001', 105, 'P-TOP-105', 'FBOX-...', 1,             â”‚
â”‚      'subscription', 1, 0, NOW(), 0),                     â”‚
â”‚     ('A001', 105, 'P-PANTS-105', 'FBOX-...', 1,           â”‚
â”‚      'subscription', 1, 0, NOW(), 0),                     â”‚
â”‚     ('A001', 105, 'P-TOWEL', 'FBOX-...', 1,               â”‚
â”‚      'subscription', 1, 0, NOW(), 0),                     â”‚
â”‚     ('A001', 105, 'P-TOWEL', 'FBOX-...', 1,               â”‚
â”‚      'voucher', NULL, 500, NOW(), 0)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. MQTT ëª…ë ¹ ì „ì†¡                                         â”‚
â”‚     (í† ì¶œ ì„±ê³µ í›„ì—ë§Œ íŠ¸ëœì­ì…˜ COMMIT)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ê¸ˆì•¡ê¶Œ ìª¼ê°œê¸° ê²°ì œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ìƒí™©: ìƒì˜ 1ê°œ ëŒ€ì—¬ (1,000ì›)                           â”‚
â”‚    ê¸ˆì•¡ê¶Œ A: ì”ì•¡ 200ì›                                    â”‚
â”‚    ê¸ˆì•¡ê¶Œ B: ì”ì•¡ 5,000ì›                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ê¸ˆì•¡ê¶Œ ì„ íƒ í™”ë©´                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ ê²°ì œ ê¸ˆì•¡: 1,000ì›                          â”‚         â”‚
â”‚   â”‚                                             â”‚         â”‚
â”‚   â”‚ [ê¸ˆì•¡ê¶Œ A] ì”ì•¡ 200ì› â–¶ ì‚¬ìš©: [200]ì›       â”‚         â”‚
â”‚   â”‚ [ê¸ˆì•¡ê¶Œ B] ì”ì•¡ 5,000ì› â–¶ ì‚¬ìš©: [800]ì›     â”‚         â”‚
â”‚   â”‚                                             â”‚         â”‚
â”‚   â”‚ ì„ íƒ í•©ê³„: 1,000ì› âœ“                        â”‚         â”‚
â”‚   â”‚ [ê²°ì œí•˜ê¸°]                                  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. íŠ¸ëœì­ì…˜ ì²˜ë¦¬                                           â”‚
â”‚                                                            â”‚
â”‚    a) ê¸ˆì•¡ê¶Œ A ì°¨ê°:                                       â”‚
â”‚       UPDATE member_vouchers SET remaining_amount = 0      â”‚
â”‚       WHERE id = 1                                         â”‚
â”‚                                                            â”‚
â”‚       INSERT INTO voucher_transactions                     â”‚
â”‚       (voucher_id, amount, type, rental_log_id)           â”‚
â”‚       VALUES (1, 200, 'use', 123)                         â”‚
â”‚                                                            â”‚
â”‚    b) ê¸ˆì•¡ê¶Œ B ì°¨ê°:                                       â”‚
â”‚       UPDATE member_vouchers                               â”‚
â”‚       SET remaining_amount = 4200                          â”‚
â”‚       WHERE id = 2                                         â”‚
â”‚                                                            â”‚
â”‚       INSERT INTO voucher_transactions                     â”‚
â”‚       (voucher_id, amount, type, rental_log_id)           â”‚
â”‚       VALUES (2, 800, 'use', 123)                         â”‚
â”‚                                                            â”‚
â”‚    c) ê¸ˆì•¡ê¶Œ A ì†Œì§„ ì²˜ë¦¬:                                  â”‚
â”‚       UPDATE member_vouchers SET status = 'exhausted'      â”‚
â”‚       WHERE id = 1                                         â”‚
â”‚                                                            â”‚
â”‚    d) ê¸ˆì•¡ê¶Œ A ì—°ê²° ë³´ë„ˆìŠ¤ í™œì„±í™”:                         â”‚
â”‚       UPDATE member_vouchers SET status = 'active'         â”‚
â”‚       WHERE parent_voucher_id = 1                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. MQTT DISPENSE ëª…ë ¹ ì „ì†¡                                 â”‚
â”‚    â†’ í† ì¶œ ì„±ê³µ ì‹œ COMMIT                                   â”‚
â”‚    â†’ í† ì¶œ ì‹¤íŒ¨ ì‹œ ROLLBACK (ê¸ˆì•¡ ë³µêµ¬)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 MQTT ëª…ë ¹ ë° ë¬¼í’ˆ í† ì¶œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. MQTT ëª…ë ¹ ì „ì†¡ (ìˆœì°¨ì )                                â”‚
â”‚                                                            â”‚
â”‚     a) ìƒì˜ 105                                            â”‚
â”‚        Topic: fbox/FBOX-xxx/cmd                            â”‚
â”‚        Payload: {"cmd": "DISPENSE", "timestamp": ...}      â”‚
â”‚                                                            â”‚
â”‚     b) í•˜ì˜ 105                                            â”‚
â”‚        Topic: fbox/FBOX-xxx/cmd                            â”‚
â”‚        Payload: {"cmd": "DISPENSE", "timestamp": ...}      â”‚
â”‚                                                            â”‚
â”‚     c) ìˆ˜ê±´ (2íšŒ)                                          â”‚
â”‚        Topic: fbox/FBOX-xxx/cmd                            â”‚
â”‚        (1ì´ˆ ëŒ€ê¸° í›„ ì¬ì „ì†¡)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 16. ESP32 ì²˜ë¦¬                                             â”‚
â”‚     a) ì¬ê³  í™•ì¸ (stock > 0?)                              â”‚
â”‚     b) ëª¨í„° êµ¬ë™ (15mm ì´ë™)                               â”‚
â”‚     c) ì¬ê³  ì°¨ê° (stock--)                                 â”‚
â”‚     d) ì´ë²¤íŠ¸ ë°œí–‰:                                        â”‚
â”‚        Topic: fbox/{deviceId}/status                       â”‚
â”‚        Payload:                                            â”‚
â”‚        {                                                   â”‚
â”‚          "event": "dispense_complete",                     â”‚
â”‚          "deviceId": "FBOX-...",                           â”‚
â”‚          "stock": 14,                                      â”‚
â”‚          "timestamp": ...                                  â”‚
â”‚        }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 17. ë¼ì¦ˆë² ë¦¬íŒŒì´: dispense_complete ìˆ˜ì‹                    â”‚
â”‚     a) íŠ¸ëœì­ì…˜ COMMIT                                     â”‚
â”‚     b) device_cache, products.stock ì—…ë°ì´íŠ¸               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 18. í™”ë©´ í‘œì‹œ                                              â”‚
â”‚     "ëŒ€ì—¬ ì™„ë£Œ! ğŸ˜Š"                                        â”‚
â”‚     "ê¸ˆì•¡ê¶Œ ì”ì•¡: 49,500ì›"                                â”‚
â”‚                                                            â”‚
â”‚     (3ì´ˆ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 19. Google Sheets ë™ê¸°í™” (5ì´ˆ ë°°ì¹˜)                        â”‚
â”‚     - rental_historyì— ì¶”ê°€                                â”‚
â”‚     - voucher_transactionsì— ì¶”ê°€                          â”‚
â”‚     - member_vouchers ì”ì•¡ ì—…ë°ì´íŠ¸                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ì¼ì¼ ì‚¬ìš©ëŸ‰ ë¦¬ì…‹ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë§¤ì¼ ìì • (KST 00:00)                                      â”‚
â”‚                                                            â”‚
â”‚ subscription_usage í…Œì´ë¸”ì€ ë‚ ì§œë³„ë¡œ ê¸°ë¡ë˜ë¯€ë¡œ            â”‚
â”‚ ìì •ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ìƒˆ ë‚ ì§œë¡œ ì¡°íšŒë¨                    â”‚
â”‚                                                            â”‚
â”‚ ì¡°íšŒ ì¿¼ë¦¬:                                                 â”‚
â”‚ SELECT SUM(quantity) FROM subscription_usage               â”‚
â”‚ WHERE date(usage_date) = date('now', 'localtime')         â”‚
â”‚   AND member_id = ?                                        â”‚
â”‚   AND subscription_id = ?                                  â”‚
â”‚   AND category = ?                                         â”‚
â”‚                                                            â”‚
â”‚ â†’ ìì • ì´í›„ ìƒˆ ë‚ ì§œì—ëŠ” ì‚¬ìš©ëŸ‰ 0ìœ¼ë¡œ ì‹œì‘                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ê¸ˆì•¡ê¶Œ ë³´ë„ˆìŠ¤ í™œì„±í™” í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ê¸ˆì•¡ê¶Œ A (10ë§Œì›) êµ¬ë§¤ ì‹œ                               â”‚
â”‚    - member_vouchersì— ê¸ˆì•¡ê¶Œ A ìƒì„± (status: active)      â”‚
â”‚    - member_vouchersì— ë³´ë„ˆìŠ¤ B ìƒì„± (status: pending)     â”‚
â”‚      â†’ parent_voucher_id = Aì˜ id                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ê¸ˆì•¡ê¶Œ A ì‚¬ìš© (ì”ì•¡ ê°ì†Œ)                               â”‚
â”‚    100,000 â†’ 50,000 â†’ 10,000 â†’ 0                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ê¸ˆì•¡ê¶Œ A ì”ì•¡ì´ 0ì´ ë˜ë©´                                â”‚
â”‚                                                            â”‚
â”‚    a) ê¸ˆì•¡ê¶Œ A ìƒíƒœ ë³€ê²½:                                  â”‚
â”‚       UPDATE member_vouchers SET status = 'exhausted'      â”‚
â”‚       WHERE id = A                                         â”‚
â”‚                                                            â”‚
â”‚    b) ë³´ë„ˆìŠ¤ B í™œì„±í™”:                                     â”‚
â”‚       UPDATE member_vouchers                               â”‚
â”‚       SET status = 'active',                               â”‚
â”‚           valid_from = NOW(),                              â”‚
â”‚           valid_until = NOW() + validity_days              â”‚
â”‚       WHERE parent_voucher_id = A AND status = 'pending'   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ë§Œì•½ ê¸ˆì•¡ê¶Œ Aê°€ ë§Œë£Œë˜ë©´ (ì”ì•¡ ë‚¨ì€ ìƒíƒœ)               â”‚
â”‚                                                            â”‚
â”‚    a) ê¸ˆì•¡ê¶Œ A ìƒíƒœ ë³€ê²½:                                  â”‚
â”‚       UPDATE member_vouchers SET status = 'expired'        â”‚
â”‚       WHERE id = A                                         â”‚
â”‚                                                            â”‚
â”‚    b) ë³´ë„ˆìŠ¤ Bë„ ë§Œë£Œ:                                     â”‚
â”‚       UPDATE member_vouchers SET status = 'expired'        â”‚
â”‚       WHERE parent_voucher_id = A AND status = 'pending'   â”‚
â”‚                                                            â”‚
â”‚    â†’ ë³´ë„ˆìŠ¤ëŠ” ë¶€ëª¨ ê¸ˆì•¡ê¶Œ "ì†Œì§„" ì‹œì—ë§Œ í™œì„±í™”             â”‚
â”‚    â†’ ë¶€ëª¨ "ë§Œë£Œ" ì‹œì—ëŠ” ë³´ë„ˆìŠ¤ë„ í•¨ê»˜ ë§Œë£Œ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ë§ˆì´í˜ì´ì§€ ë°ì´í„° ì¡°íšŒ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/member/{member_id}/cards                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ëª¨ë“  ê¸ˆì•¡ê¶Œ ì¡°íšŒ                                        â”‚
â”‚    SELECT mv.*, vp.name AS product_name                    â”‚
â”‚    FROM member_vouchers mv                                 â”‚
â”‚    JOIN voucher_products vp ON mv.product_id = vp.id      â”‚
â”‚    WHERE mv.member_id = ?                                  â”‚
â”‚    ORDER BY mv.status, mv.valid_until                     â”‚
â”‚                                                            â”‚
â”‚    ê²°ê³¼:                                                   â”‚
â”‚    - í™œì„± ê¸ˆì•¡ê¶Œë“¤ (active)                                â”‚
â”‚    - ëŒ€ê¸°ì¤‘ ë³´ë„ˆìŠ¤ ê¸ˆì•¡ê¶Œë“¤ (pending)                      â”‚
â”‚    - ì†Œì§„ëœ ê¸ˆì•¡ê¶Œë“¤ (exhausted)                           â”‚
â”‚    - ë§Œë£Œëœ ê¸ˆì•¡ê¶Œë“¤ (expired)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ëª¨ë“  êµ¬ë…ê¶Œ ì¡°íšŒ                                        â”‚
â”‚    SELECT ms.*, sp.name AS product_name                    â”‚
â”‚    FROM member_subscriptions ms                            â”‚
â”‚    JOIN subscription_products sp ON ms.product_id = sp.id â”‚
â”‚    WHERE ms.member_id = ?                                  â”‚
â”‚    ORDER BY ms.status, ms.valid_until                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ì‘ë‹µ êµ¬ì„±                                               â”‚
â”‚    {                                                       â”‚
â”‚      "vouchers": [                                         â”‚
â”‚        {                                                   â”‚
â”‚          "id": 1,                                          â”‚
â”‚          "product_name": "10ë§Œì› ê¸ˆì•¡ê¶Œ",                  â”‚
â”‚          "original_amount": 100000,                        â”‚
â”‚          "remaining_amount": 45000,                        â”‚
â”‚          "status": "active",                               â”‚
â”‚          "valid_until": "2025-12-01"                       â”‚
â”‚        },                                                  â”‚
â”‚        {                                                   â”‚
â”‚          "id": 2,                                          â”‚
â”‚          "product_name": "1ë§Œì› ë³´ë„ˆìŠ¤",                   â”‚
â”‚          "original_amount": 10000,                         â”‚
â”‚          "remaining_amount": 10000,                        â”‚
â”‚          "status": "pending",                              â”‚
â”‚          "parent_voucher_id": 1                            â”‚
â”‚        }                                                   â”‚
â”‚      ],                                                    â”‚
â”‚      "subscriptions": [...]                                â”‚
â”‚    }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì—ëŸ¬ ì²˜ë¦¬ í”Œë¡œìš°

### 5.1 í† ì¶œ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. MQTT ëª…ë ¹: DISPENSE                                     â”‚
â”‚    (ê¸ˆì•¡ê¶Œ ì°¨ê°ì€ ì´ë¯¸ DBì— ë°˜ì˜ë¨ - íŠ¸ëœì­ì…˜ ì§„í–‰ ì¤‘)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32: ì¬ê³  í™•ì¸ â†’ ì¬ê³  ì—†ìŒ                            â”‚
â”‚    {                                                       â”‚
â”‚      "event": "dispense_failed",                           â”‚
â”‚      "reason": "no_stock",                                 â”‚
â”‚      "stock": 0                                            â”‚
â”‚    }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ë¼ì¦ˆë² ë¦¬íŒŒì´: íŠ¸ëœì­ì…˜ ë¡¤ë°±                             â”‚
â”‚    ROLLBACK                                                â”‚
â”‚                                                            â”‚
â”‚    â†’ ê¸ˆì•¡ê¶Œ ì”ì•¡ ë³µêµ¬                                      â”‚
â”‚    â†’ voucher_transactions ê¸°ë¡ ì·¨ì†Œ                        â”‚
â”‚    â†’ rental_logs ê¸°ë¡ ì·¨ì†Œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ                             â”‚
â”‚    "ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë°ì´í„° íë¦„ ìš”ì•½í‘œ

| í”Œë¡œìš° | íŠ¸ë¦¬ê±° | ì£¼ìš” ë°ì´í„° | ë™ê¸°í™” ëŒ€ìƒ |
|--------|--------|-------------|-------------|
| ë½ì¹´ ë°°ì • | ë½ì¹´í‚¤ ëŒ€ì—¬ê¸° | locker_mapping | - |
| êµ¬ë…ê¶Œ ëŒ€ì—¬ | ìƒí’ˆ ì„ íƒ | subscription_usage, rental_logs | rental_history |
| ê¸ˆì•¡ê¶Œ ëŒ€ì—¬ | ìƒí’ˆ ì„ íƒ | member_vouchers, voucher_transactions, rental_logs | member_vouchers, voucher_transactions, rental_history |
| ë³´ë„ˆìŠ¤ í™œì„±í™” | ê¸ˆì•¡ê¶Œ ì†Œì§„ | member_vouchers.status | member_vouchers |
| ì¬ê³  ë³´ì¶© | ë¬¸ ë‹«í˜ | device_cache.stock, products.stock | device_status, products |

---

## ë²„ì „ ì´ë ¥

- **v1.0.0** (2024-12-01): ì´ˆê¸° ë²„ì „ (íšŸìˆ˜ ê¸°ë°˜)
- **v2.0.0** (2024-12-03): ê¸ˆì•¡ê¶Œ/êµ¬ë…ê¶Œ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
