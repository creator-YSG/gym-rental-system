# F-BOX 시스템 데이터 흐름도

## 개요

F-BOX 시스템의 주요 데이터 흐름을 시나리오별로 설명합니다.

---

## 시스템 구성 요소

```
┌─────────────────┐
│  락카키 대여기   │
│  (터치스크린)    │
└────────┬────────┘
         │ HTTP POST
         ↓
┌──────────────────────────────────────┐
│   운동복/수건 대여기 라즈베리파이     │
│                                      │
│  ┌──────────┐  ┌────────────────┐  │
│  │  SQLite  │  │  MQTT 브로커   │  │
│  │ (로컬 DB)│  │  (Mosquitto)   │  │
│  └──────────┘  └────────┬───────┘  │
└──────────────────────────┼──────────┘
                          │ MQTT
          ┌───────────────┼───────────────┐
          ↓               ↓               ↓
    ┌─────────┐     ┌─────────┐     ┌─────────┐
    │ ESP32   │     │ ESP32   │     │ ESP32   │
    │ 상의 105│     │ 하의 105│     │  수건   │
    └─────────┘     └─────────┘     └─────────┘
          ↑               ↑               ↑
      (모터+센서)    (모터+센서)    (모터+센서)
```

---

## 1. 시스템 초기화 플로우

### 1.1 라즈베리파이 부팅

```
┌────────────────────────────────────────────────────────────┐
│ 1. 라즈베리파이 부팅                                        │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 2. SQLite 데이터베이스 연결                                 │
│    - /instance/fbox_local.db 열기                          │
│    - 테이블 존재 확인                                       │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 3. Google Sheets 동기화 (다운로드)                         │
│    - members 시트 → SQLite members 테이블                  │
│    - products 시트 → SQLite products 테이블                │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 4. MQTT 브로커 시작 (Mosquitto)                            │
│    - 포트 1883 리스닝                                       │
│    - allow_anonymous true (개발 단계)                      │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 5. Flask 웹 서버 시작                                       │
│    - REST API 엔드포인트 등록                               │
│    - 포트 5000 리스닝                                       │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 6. MQTT 구독 시작                                           │
│    - fbox/+/status (모든 기기 이벤트)                      │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 7. 백그라운드 작업 시작                                     │
│    - Sheets 동기화 스레드 (5분마다)                        │
│    - 기기 상태 모니터링 스레드 (1분마다)                    │
└────────────────────────────────────────────────────────────┘
```

### 1.2 ESP32 부팅

```
┌────────────────────────────────────────────────────────────┐
│ 1. ESP32 전원 ON                                            │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 2. NVS에서 설정 로드                                        │
│    - Wi-Fi SSID/Password                                   │
│    - Device ID (예: FBOX-UPPER-105)                        │
│    - Size (예: 105)                                         │
│    - Broker Host (라즈베리파이 IP)                         │
└────────────────┬───────────────────────────────────────────┘
                 ↓
       ┌─────────┴─────────┐
       │  설정 있음?       │
       └─────┬─────────┬───┘
        YES  │         │ NO
             ↓         ↓
     ┌──────────┐  ┌──────────────┐
     │ RUN 모드 │  │ SETUP 모드    │
     └────┬─────┘  │ - AP 모드     │
          │        │ - QR 코드 표시│
          │        └───────────────┘
          ↓
┌────────────────────────────────────────────────────────────┐
│ 3. Wi-Fi 연결                                               │
│    - SSID에 연결 시도 (최대 20회)                          │
│    - IP 주소 획득 (DHCP)                                    │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 4. MQTT 연결                                                │
│    - mqttClient.setServer(brokerHost, 1883)                │
│    - mqttClient.connect(deviceId)                          │
│    - Subscribe: fbox/{deviceId}/cmd                        │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 5. boot_complete 이벤트 발행                                │
│    Topic: fbox/{deviceId}/status                           │
│    Payload:                                                │
│    {                                                       │
│      "event": "boot_complete",                             │
│      "deviceId": "FBOX-UPPER-105",                         │
│      "size": "105",                                         │
│      "stock": 15,                                           │
│      "firmwareVersion": "v1.0.0",                          │
│      "ipAddress": "192.168.1.100"                          │
│    }                                                       │
└────────────────┬───────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────────────────────────┐
│ 6. Heartbeat 시작 (1분마다)                                 │
│ 7. 하드웨어 초기화 (모터, 리미트 스위치, LCD)               │
└────────────────────────────────────────────────────────────┘
```

---

## 2. 락카키 배정 플로우

### 중요: Pull 방식 API

운동복 대여기가 필요할 때만 락카키 대여기에 회원 정보를 질의합니다.
(락카만 빌리고 운동복 안 빌리는 사람이 많으므로 Push 방식보다 효율적)

```
┌───────────────────────────────────────────────────────────┐
│ 1. 락카키 대여기: 회원 인증                                 │
│    - NFC 카드 / QR 코드 / 전화번호 입력                    │
│    - 회원 ID: A001 (홍길동)                                │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. 빈 락카 찾기                                            │
│    - 105번 락카 선택                                        │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 락카키 대여기 라즈베리파이: 내부 API 호출                │
│    POST /api/locker/assign                                 │
│    Body: {"locker": 105, "member": "A001"}                │
│                                                            │
│    → SQLite에 락카-회원 매핑 저장                          │
│      INSERT INTO locker_mapping VALUES (105, 'A001', ...)  │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 락카키 대여기: 락카 열림                                 │
│    - 105번 락카 전자잠금 해제                               │
│    - 화면: "105번 락카를 이용하세요"                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. Google Sheets 기록 (비동기)                             │
│    - locker_assignments 시트에 새 행 추가                  │
│      [105, A001, 2024-12-01 10:00:00, , active]           │
└───────────────────────────────────────────────────────────┘

*** 운동복 대여기에는 아직 아무것도 전달되지 않음! ***
*** 회원이 운동복/수건 빌리러 가면 그때 조회함 ***
```

---

## 3. 운동복/수건 대여 플로우

### 3.1 NFC 태그 및 회원 조회 (Pull 방식)

```
┌───────────────────────────────────────────────────────────┐
│ 1. 사용자: 락카키 NFC 태그                                  │
│    - 락카키 번호: 105                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. 운동복 대여기 → 락카키 대여기 API 호출                  │
│    HTTP GET                                                │
│    URL: http://{락카키대여기IP}:5000/api/member/by-locker/105│
│                                                            │
│    *** 이 시점에 락카키 대여기에서 회원 정보 조회 ***      │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 락카키 대여기 응답                                       │
│    {                                                       │
│      "status": "ok",                                       │
│      "locker_number": 105,                                 │
│      "member_id": "A001",                                  │
│      "name": "홍길동",                                      │
│      "remaining_count": 10,   ← 잔여 횟수                  │
│      "assigned_at": "2024-12-01T10:00:00"                  │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 상품 목록 조회                                          │
│    SQL:                                                    │
│    SELECT * FROM products                                  │
│    WHERE enabled = 1                                       │
│    ORDER BY display_order                                  │
│                                                            │
│    결과: 운동복 상의/하의, 수건                            │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. 터치스크린에 표시                                        │
│   ┌─────────────────────────────────────────────┐         │
│   │ 홍길동님 (잔액: 10,000원)                   │         │
│   ├─────────────────────────────────────────────┤         │
│   │ 운동복 상의                                 │         │
│   │  □ 95 (1000원)                              │         │
│   │  □ 100 (1000원)                             │         │
│   │  ☑ 105 (1000원) ← 선택                     │         │
│   │  □ 110 (1000원)                             │         │
│   │ 운동복 하의                                 │         │
│   │  ☑ 105 (1000원) ← 선택                     │         │
│   │ 수건                                        │         │
│   │  ☑ 수건 (500원) x2 ← 선택                  │         │
│   ├─────────────────────────────────────────────┤         │
│   │ 합계: 3,000원                               │         │
│   │ [대여하기]                                  │         │
│   └─────────────────────────────────────────────┘         │
└───────────────────────────────────────────────────────────┘
```

### 3.2 대여 처리 (트랜잭션)

```
┌───────────────────────────────────────────────────────────┐
│ 6. 사용자: [대여하기] 버튼 클릭                            │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 7. 잔여 횟수 확인                                          │
│    IF remaining_count (10) >= total_items (3) THEN OK      │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 9. 데이터베이스 트랜잭션 시작                              │
│    BEGIN TRANSACTION                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 8. 횟수 차감                                               │
│     UPDATE members                                         │
│     SET remaining_count = remaining_count - 3,             │
│         total_used = total_used + 3,                       │
│         updated_at = NOW()                                 │
│     WHERE member_id = 'A001'                               │
│                                                            │
│     (10회 → 7회)                                           │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 9. 대여 로그 기록 (각 상품별)                              │
│     INSERT INTO rental_logs VALUES                         │
│     ('A001', 105, 'P-UPPER-105', 'FBOX-UPPER-105',         │
│      1, 10, 9, NOW(), 0),  ← quantity=1, 10회→9회          │
│                                                            │
│     ('A001', 105, 'P-LOWER-105', 'FBOX-LOWER-105',         │
│      1, 9, 8, NOW(), 0),   ← quantity=1, 9회→8회           │
│                                                            │
│     ('A001', 105, 'P-TOWEL', 'FBOX-TOWEL-01',              │
│      1, 8, 7, NOW(), 0)    ← quantity=1, 8회→7회           │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 10. 횟수 변동 로그 기록                                    │
│     INSERT INTO usage_logs VALUES                          │
│     ('A001', -3, 10, 7, 'rental',                          │
│      '운동복/수건 대여', NULL, NOW())                      │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 13. 트랜잭션 커밋                                          │
│     COMMIT                                                 │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 14. 화면 표시                                              │
│     "처리 중... 잠시만 기다려주세요"                       │
└───────────────────────────────────────────────────────────┘
```

### 3.3 MQTT 명령 전송 및 물품 토출

```
┌───────────────────────────────────────────────────────────┐
│ 15. MQTT 명령 전송 (순차적)                                │
│                                                            │
│     a) 상의 105                                            │
│        Topic: fbox/FBOX-UPPER-105/cmd                      │
│        Payload: {"cmd": "DISPENSE", "timestamp": ...}      │
│                                                            │
│     b) 하의 105                                            │
│        Topic: fbox/FBOX-LOWER-105/cmd                      │
│        Payload: {"cmd": "DISPENSE", "timestamp": ...}      │
│                                                            │
│     c) 수건 (2회)                                          │
│        Topic: fbox/FBOX-TOWEL-01/cmd                       │
│        Payload: {"cmd": "DISPENSE", "timestamp": ...}      │
│        (1초 대기 후 재전송)                                │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 16. ESP32 처리                                             │
│                                                            │
│     각 ESP32가 명령 수신:                                  │
│     a) 재고 확인 (stock > 0?)                              │
│     b) 모터 구동 (15mm 이동)                               │
│     c) 재고 차감 (stock--)                                 │
│     d) 이벤트 발행:                                        │
│        Topic: fbox/{deviceId}/status                       │
│        Payload:                                            │
│        {                                                   │
│          "event": "dispense_complete",                     │
│          "deviceId": "FBOX-UPPER-105",                     │
│          "stock": 14,                                      │
│          "timestamp": ...                                  │
│        }                                                   │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 17. 라즈베리파이: MQTT 이벤트 수신                         │
│                                                            │
│     각 dispense_complete 이벤트 수신 시:                   │
│     a) device_cache 업데이트                               │
│        UPDATE device_cache                                 │
│        SET stock = 14, updated_at = NOW()                  │
│        WHERE device_id = 'FBOX-UPPER-105'                  │
│                                                            │
│     b) products.stock 동기화                               │
│        UPDATE products                                     │
│        SET stock = 14                                      │
│        WHERE device_id = 'FBOX-UPPER-105'                  │
│                                                            │
│     c) mqtt_events 로그 기록 (선택)                        │
│        INSERT INTO mqtt_events ...                         │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 18. 화면 표시                                              │
│     "대여 완료! 즐거운 운동 되세요 😊"                     │
│     "남은 잔액: 7,000원"                                    │
│                                                            │
│     (3초 후 메인 화면으로)                                 │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 19. Google Sheets 동기화 (5초 배치)                        │
│                                                            │
│     배치 작업이 실행되면:                                  │
│     a) rental_logs (synced_to_sheets = 0) 조회             │
│     b) Google Sheets rental_history에 추가                 │
│     c) usage_logs → usage_history에 추가                   │
│     d) members.remaining_count 업데이트                    │
│     e) synced_to_sheets = 1로 표시                         │
└───────────────────────────────────────────────────────────┘
```

---

## 4. 재고 보충 플로우

### 4.1 센서 없는 경우 (현재)

```
┌───────────────────────────────────────────────────────────┐
│ 1. 관리자: F-BOX 문 열기                                   │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. ESP32: door_opened 이벤트 발행                          │
│    Topic: fbox/FBOX-UPPER-105/status                       │
│    Payload:                                                │
│    {                                                       │
│      "event": "door_opened",                               │
│      "deviceId": "FBOX-UPPER-105",                         │
│      "timestamp": ...                                      │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 관리자: 재고 보충 (예: 15개 넣음)                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 관리자: F-BOX 문 닫기                                   │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. ESP32: 홈 복귀 자동 실행                                │
│    - 1층 도달까지 모터 구동                                │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 6. ESP32: door_closed 이벤트 발행                          │
│    Topic: fbox/FBOX-UPPER-105/status                       │
│    Payload:                                                │
│    {                                                       │
│      "event": "door_closed",                               │
│      "deviceId": "FBOX-UPPER-105",                         │
│      "stock": 14,  // 변화 없음                            │
│      "sensorAvailable": false,                             │
│      "timestamp": ...                                      │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 7. 관리자: 웹/앱에서 재고 수동 설정                        │
│    - 운동복 대여기 화면 또는 관리자 웹에서                 │
│    - "FBOX-UPPER-105 재고를 15개로 설정"                   │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 8. 라즈베리파이: MQTT 명령 전송                            │
│    Topic: fbox/FBOX-UPPER-105/cmd                          │
│    Payload:                                                │
│    {                                                       │
│      "cmd": "SET_STOCK",                                   │
│      "stock": 15,                                          │
│      "timestamp": ...                                      │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 9. ESP32: 재고 업데이트                                    │
│    currentStock = 15                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 10. ESP32: stock_updated 이벤트 발행                       │
│     Topic: fbox/FBOX-UPPER-105/status                      │
│     Payload:                                               │
│     {                                                      │
│       "event": "stock_updated",                            │
│       "deviceId": "FBOX-UPPER-105",                        │
│       "stock": 15,                                         │
│       "source": "manual",                                  │
│       "needsVerification": false,                          │
│       "timestamp": ...                                     │
│     }                                                      │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 11. 라즈베리파이: 재고 동기화                              │
│     UPDATE device_cache SET stock = 15 ...                 │
│     UPDATE products SET stock = 15 ...                     │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 12. Google Sheets 동기화                                   │
│     - device_status 시트 업데이트                          │
│     - products 시트 stock 컬럼 업데이트                    │
└───────────────────────────────────────────────────────────┘
```

### 4.2 센서 추가 후 (미래)

```
┌───────────────────────────────────────────────────────────┐
│ 1~4. (동일) 문 열기 → 재고 보충 → 문 닫기                 │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. ESP32: 홈 복귀 + 센서로 재고 자동 감지                  │
│    int detectedStock = readStockSensor(); // 15개           │
│    currentStock = detectedStock;                           │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 6. ESP32: stock_updated 이벤트 발행                        │
│    Payload:                                                │
│    {                                                       │
│      "event": "stock_updated",                             │
│      "stock": 15,                                          │
│      "source": "sensor",  ← 센서 감지                      │
│      "needsVerification": true  ← 관리자 확인 필요         │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 7. 라즈베리파이: 웹/앱에 알림                              │
│    "FBOX-UPPER-105: 센서가 15개 감지했습니다.              │
│     확인하시겠습니까?"                                     │
│                                                            │
│    [확인] [수정하기]                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 8. 관리자: 확인 또는 수정                                  │
│    - 확인 → 재고 15개로 확정                               │
│    - 수정 → 실제 개수 입력 (예: 16개)                     │
│              → SET_STOCK 명령 전송                         │
└───────────────────────────────────────────────────────────┘
```

---

## 5. 할인 쿠폰 적용 플로우

```
┌───────────────────────────────────────────────────────────┐
│ 1. 대여 시작 (3번 플로우와 동일하게 진행)                  │
│    - 상품 선택: 합계 3,000원                               │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. 쿠폰 확인                                               │
│    SELECT * FROM coupons                                   │
│    WHERE member_id = 'A001'                                │
│      AND used = 0                                          │
│      AND valid_until > NOW()                               │
│                                                            │
│    결과: 10% 할인 쿠폰 (COUPON001)                         │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 할인 적용 확인 (화면)                                   │
│    "10% 할인 쿠폰이 있습니다. 사용하시겠습니까?"           │
│    [사용] [다음에]                                         │
└────────────────┬──────────────────────────────────────────┘
          [사용] ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 할인 계산                                               │
│    원가: 3,000원                                            │
│    할인: 3,000 × 0.1 = 300원                               │
│    최종: 2,700원                                            │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. 트랜잭션 처리 (횟수 기반)                               │
│    a) 횟수 차감: 3회 (상의1+하의1+수건1)                   │
│    b) rental_logs 기록:                                    │
│       quantity = 1 (각 상품별)                             │
│       count_before, count_after                            │
│    c) usage_logs 기록                                      │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 6. MQTT 명령 및 토출 (동일)                                │
└───────────────────────────────────────────────────────────┘
```

---

## 6. 충전 프로모션 적용 플로우 (횟수 기반)

```
┌───────────────────────────────────────────────────────────┐
│ 1. 회원: 10회 충전 요청                                    │
│    (관리자 웹 또는 결제 시스템)                            │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. 프로모션 확인                                           │
│    SELECT * FROM promotions                                │
│    WHERE gym_id = 'GYM001'                                 │
│      AND promo_type = 'charge_bonus'                       │
│      AND condition_count <= 10                             │
│      AND active = 1                                        │
│                                                            │
│    결과: "10회 이상 충전 시 1회 보너스" (PROMO001)         │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 보너스 계산                                             │
│    충전 횟수: 10회                                         │
│    보너스: 1회                                             │
│    합계: 11회                                              │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 트랜잭션 처리                                           │
│    BEGIN TRANSACTION                                       │
│                                                            │
│    a) 횟수 업데이트:                                       │
│       UPDATE members                                       │
│       SET remaining_count = remaining_count + 11,          │
│           total_charged = total_charged + 10               │
│       WHERE member_id = 'A001'                             │
│                                                            │
│    b) 횟수 변동 로그 기록 (2건):                           │
│       INSERT INTO usage_logs VALUES                        │
│       ('A001', +10, 0, 10, 'charge', '10회 충전', ...),    │
│       ('A001', +1, 10, 11, 'bonus', '충전 보너스 1회', ...)│
│                                                            │
│    COMMIT                                                  │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 5. Google Sheets 동기화                                    │
│    - members 시트 remaining_count 업데이트                 │
│    - usage_history 시트에 2개 행 추가                      │
└───────────────────────────────────────────────────────────┘
```

---

## 7. 에러 처리 플로우

### 7.1 재고 부족

```
┌───────────────────────────────────────────────────────────┐
│ 1. MQTT 명령: DISPENSE                                     │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. ESP32: 재고 확인                                        │
│    IF currentStock == 0 THEN                               │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. ESP32: dispense_failed 이벤트 발행                      │
│    {                                                       │
│      "event": "dispense_failed",                           │
│      "reason": "no_stock",                                 │
│      "stock": 0                                            │
│    }                                                       │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 라즈베리파이: 에러 처리                                 │
│    - 트랜잭션 롤백 (잔액 복구)                             │
│    - 사용자에게 에러 메시지 표시                           │
│      "재고가 부족합니다. 관리자에게 문의하세요."           │
└───────────────────────────────────────────────────────────┘
```

### 7.2 네트워크 재연결

```
┌───────────────────────────────────────────────────────────┐
│ 1. ESP32: Wi-Fi 연결 끊김 감지                             │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 2. ESP32: 재연결 시도 (최대 20회)                          │
│    - 1초 간격으로 재시도                                   │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 3. 재연결 성공                                             │
│    - MQTT 재연결                                           │
│    - wifi_reconnected 이벤트 발행                          │
└────────────────┬──────────────────────────────────────────┘
                 ↓
┌───────────────────────────────────────────────────────────┐
│ 4. 라즈베리파이: 상태 동기화                               │
│    - STATUS 명령 전송                                      │
│    - device_cache 업데이트                                 │
└───────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름 요약표 (횟수 기반)

| 플로우 | 트리거 | 주요 데이터 | 동기화 대상 |
|--------|--------|-------------|-------------|
| 락카 배정 | 락카키 대여기 | locker_mapping | Google Sheets (locker_assignments) |
| 대여 처리 | NFC 태그 | members.remaining_count, rental_logs | Google Sheets (rental_history, usage_history) |
| 재고 보충 | 문 닫힘 | device_cache.stock, products.stock | Google Sheets (products, device_status) |
| 충전 | 결제 완료 | members.remaining_count, usage_logs | Google Sheets (members, usage_history) |
| 기기 상태 | Heartbeat | device_cache | Google Sheets (device_status) |

**참고**: 1개 대여 = 1회 차감 (상의 1 + 하의 1 + 수건 1 = 3회 차감)

---

## 성능 고려사항

### 동시 대여 처리
- SQLite는 단일 쓰기만 지원 → 트랜잭션 직렬화 필요
- 대기 큐 구현 또는 락(Lock) 사용

### Google Sheets API 제한
- 분당 60회 제한 → 배치 처리로 최적화
- 5초마다 배치 업로드 (최대 12회/분)

### MQTT QoS
- 중요 명령 (DISPENSE): QoS 1
- Heartbeat: QoS 0

---

이상으로 F-BOX 시스템의 주요 데이터 흐름을 정리했습니다.

